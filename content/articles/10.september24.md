---
date: 2024/09/24
layout: article
title: September 2024
description: Notes for the month of September, 2024 (ongoing)
tag: microservices, nats
author: You
---

## client health checks

- now how does nats know if a listener has gone offline? we sort of already wrote that in the `nats-depl` file
- `-hbi` `-5s` is a basically like a heart beat flag thats sent by nats to the entity every 5s
- `-hbt` `-5s` is how long the entity has to give a response to the heartbeat
- `-hbf` `2` is how many times the entity can fail before its removed from the subscription
- which is also why we've added 2 signal listeners SIGTERM and SIGINT
- upon receiving either of these signals, we'll be triggering the shutdown process

```ts
process.on("SIGINT", () => stan.close());
process.on("SIGTERM", () => stan.close());
```

- but lets say we force quit the terminal or something, the server would still think the listener is active, which is why we have a fallback to heartbeat and failure etc

### NOTE ABOUT SCALABILITY

- scaling upwards - increasing specs, making it faster
- scaling horizontally - increasing the no: of replicas and instances running

## event redelivery

- in the case that a listener goes down, or if you added a new listener to the queue group
- there is one way you can update it w all the events that have taken place so far, and that is by chaining another option, the `setDeliverAllAvailable()`
- this option will deliver all the events that took place
- but this isnt feasible, because what if we have 1000s or even more events, sending everything could crash our service
- so to fix this we're going to work on something called a durable subscription, which is basically a sub with an id
- so to do this, we add another option called `setDurableName()` and within this we pass in an identifier
- inside, NATS is going to keep track of all the durable subs we have
- then, for every event that was published and ack, NATS is going to keep track of all the events successfully processed along side this subs' id
- so a combination of these gives us a durable subscription that remembers what events were passed, ackd and procd

```ts
const options = stan
  .subscriptionOptions()
  .setManualAckMode(true)
  .setDeliverAllAvailable()
  .setDurableName("orders-service");

const subscription = stan.subscribe(
  "ticket:created",
  "orders-service-queue-group",
  options
);
```
